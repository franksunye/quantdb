# QuantDB 端到端测试指南

本文档详细说明了QuantDB项目的端到端测试策略和实现方法，特别是基于真实服务器的HTTP API测试。

## 1. 端到端测试的重要性

端到端测试是验证整个系统功能的关键环节，它模拟真实用户的使用场景，从外部调用系统API，验证系统的所有组件能够正确协同工作。在QuantDB项目中，端到端测试尤为重要，因为：

1. **验证完整数据流**: 测试从用户请求到数据获取、处理、存储和返回的完整流程
2. **检测集成问题**: 发现单元测试和集成测试无法发现的组件间交互问题
3. **确保系统稳定性**: 作为回归测试的基础，确保新功能不会破坏现有功能
4. **模拟真实场景**: 使用真实HTTP请求，模拟客户端实际使用情况

## 2. 测试架构对比

QuantDB项目实现了三种不同的端到端测试方法，各有优缺点：

| 测试方法 | 文件 | 优点 | 缺点 |
|---------|------|------|------|
| 原始架构API测试 | `test_stock_data_api_original.py` | 测试原始架构的功能 | 使用TestClient，不是真正的HTTP请求 |
| 简化架构API测试 | `test_stock_data_api_simplified.py` | 测试简化架构的功能 | 使用TestClient，不是真正的HTTP请求 |
| 真实HTTP API测试 | `test_stock_data_http_api.py` | 使用真实HTTP请求，最接近实际使用场景 | 需要单独启动服务器，测试运行时间较长 |

### 2.1 TestClient vs 真实HTTP请求

FastAPI的TestClient提供了一种便捷的方式来测试API，但它有以下局限性：

- 不会测试真实的HTTP服务器（如Uvicorn）
- 不会测试网络传输层
- 不会测试中间件和服务器配置
- 不会测试多进程/多线程环境下的行为

相比之下，基于真实服务器的HTTP测试能够：

- 验证完整的部署栈，包括HTTP服务器
- 测试网络传输和序列化/反序列化过程
- 验证中间件和服务器配置的正确性
- 测试在真实环境中的性能和稳定性

## 3. 测试文件说明

### 3.1 测试文件概述

- `test_stock_data_api_original.py`: 原始架构的API测试（使用TestClient）
- `test_stock_data_api_simplified.py`: 简化架构的API测试（使用TestClient）
- `test_stock_data_http_api.py`: 简化架构的HTTP API测试（使用真实HTTP请求）

### 3.2 真实HTTP API测试详解

`test_stock_data_http_api.py` 实现了基于真实服务器的HTTP API测试，它：

1. 连接到单独启动的测试服务器
2. 发送真实的HTTP请求
3. 验证响应和数据库状态
4. 测试各种场景下的系统行为

这种测试方法最接近实际使用场景，能够发现其他测试方法无法发现的问题。

## 4. 运行HTTP API端到端测试

HTTP API端到端测试需要先启动测试服务器，然后在另一个终端运行测试。

### 4.1 启动测试服务器

在项目根目录运行:

```bash
python start_test_server.py --port 8766
```

服务器将在端口8766上启动。保持此终端窗口打开。

服务器启动脚本 `start_test_server.py` 具有以下特性：

- 自动检查端口占用情况
- 验证服务器是否成功启动
- 提供详细的日志输出
- 测试API端点可用性

### 4.2 运行测试

在另一个终端窗口中，运行所有测试:

```bash
python -m unittest tests.e2e.test_stock_data_http_api
```

或者运行特定测试:

```bash
python -m unittest tests.e2e.test_stock_data_http_api.TestStockDataHTTPAPI.test_empty_database_flow
```

### 4.3 停止服务器

测试完成后，回到运行服务器的终端，按`Ctrl+C`停止服务器。

## 5. 测试场景详解

HTTP API端到端测试包含以下主要场景:

### 5.1 空数据库流程 (`test_empty_database_flow`)

**目的**: 验证当数据库为空时，系统能够从AKShare获取数据并保存到数据库

**测试流程**:
1. 清空数据库中的目标数据
2. 验证数据库确实为空
3. 发送API请求获取股票数据
4. 验证响应状态码和数据内容
5. 验证数据已正确保存到数据库

**预期结果**:
- API返回状态码200和正确的数据
- 数据库中包含新获取的数据
- 响应时间在合理范围内

### 5.2 完全缓存命中流程 (`test_complete_cache_hit_flow`)

**目的**: 验证当请求的所有数据已在数据库中时，系统能够直接从数据库返回数据

**测试流程**:
1. 清空数据库中的目标数据
2. 验证数据库确实为空
3. 发送第一次API请求获取股票数据（从AKShare获取）
4. 验证数据已保存到数据库
5. 发送第二次相同的API请求（应从数据库获取）
6. 验证两次响应的数据完全相同
7. 比较两次请求的响应时间

**预期结果**:
- 两次API请求都返回状态码200和相同的数据
- 第二次请求的响应时间明显快于第一次
- 第二次请求不会从AKShare获取数据

### 5.3 部分缓存命中流程 (`test_partial_cache_hit_flow`)

**目的**: 验证当部分数据在数据库中时，系统只从AKShare获取缺失的部分

**测试流程**:
1. 清空数据库中的目标数据
2. 验证数据库确实为空
3. 发送第一次API请求获取部分日期范围的数据
4. 验证部分数据已保存到数据库
5. 发送第二次API请求获取完整日期范围的数据
6. 验证系统只获取了缺失的部分数据
7. 验证完整数据已正确合并并保存到数据库

**预期结果**:
- 第二次请求返回完整的数据集
- 数据库中包含完整的数据
- 第二次请求的响应时间小于理论上完全获取所需的时间

### 5.4 无效股票代码处理 (`test_invalid_symbol_handling`)

**目的**: 验证系统对无效股票代码的处理

**测试流程**:
1. 发送请求获取格式无效的股票代码数据
2. 验证系统返回适当的错误响应
3. 发送请求获取不存在的股票代码数据
4. 验证系统返回适当的响应

**预期结果**:
- 格式无效的股票代码请求返回状态码400和错误信息
- 不存在的股票代码请求返回状态码200和空数据
- 数据库中不会保存无效股票的数据

## 6. 测试设计原则

HTTP API端到端测试遵循以下设计原则：

1. **独立性**: 每个测试都是独立的，不依赖于其他测试的执行结果
2. **可重复性**: 测试可以重复执行，每次都产生相同的结果
3. **可验证性**: 测试包含明确的验证步骤，确保系统行为符合预期
4. **全面性**: 测试覆盖所有关键场景和边缘情况
5. **健壮性**: 测试能够处理各种异常情况，不会因为小问题而失败

## 7. 注意事项

- 测试使用端口8766，避免与开发服务器（通常使用8000）冲突
- 测试会清空数据库中的相关数据，请不要在生产环境运行
- 测试使用固定的日期范围（2025年4月的工作日），以确保测试的一致性
- 测试服务器和测试脚本应在不同的终端窗口中运行
- 如果测试失败，请检查服务器日志以获取更多信息

## 8. 未来改进

1. **自动化服务器管理**: 开发脚本自动启动和停止测试服务器
2. **并行测试执行**: 支持并行运行多个测试，提高测试效率
3. **性能基准测试**: 添加性能基准测试，监控系统性能变化
4. **测试数据管理**: 改进测试数据管理，支持更复杂的测试场景
5. **持续集成**: 集成到CI/CD流程，自动运行端到端测试

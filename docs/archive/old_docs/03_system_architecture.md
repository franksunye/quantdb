# QuantDB 系统架构 V2

## 文档信息
**文档类型**: 架构设计
**文档编号**: quantdb-ARCH-002
**版本**: 2.0.0
**创建日期**: 2025-06-07
**最后更新**: 2025-05-28
**状态**: 正式版本 (简化架构完成)
**负责人**: frank

## 1. 概述

本文档描述了 QuantDB 系统的架构设计 V2 版本，重点是简化的缓存架构和智能数据获取策略。

### 1.1 当前实现状态

**完成日期**: 2025-05-28
**实现版本**: SQLite 开发版本
**测试状态**: 80/80 核心功能测试通过 (100%)

简化架构已经完成并投入使用，所有核心功能均在 SQLite 开发环境中稳定运行。系统已移除了复杂的缓存层，采用数据库作为主要缓存，显著提高了系统的可维护性和稳定性。

## 2. 架构目标

- **简化系统架构**：减少组件数量，降低系统复杂性
- **提高数据获取效率**：实现智能数据获取策略，减少不必要的 API 调用
- **优化数据库使用**：使用数据库作为持久化缓存，提高数据访问性能
- **提高系统可维护性**：减少组件之间的依赖，提高代码可读性和可维护性
- **保持系统可扩展性**：为未来支持更多数据类型和数据源预留扩展点

## 3. 系统组件

### 3.1 核心组件

#### 3.1.1 API 层

- **FastAPI 应用**：提供 RESTful API 接口
- **路由处理器**：处理 API 请求，调用相应的服务
- **请求验证**：验证 API 请求参数
- **响应格式化**：格式化 API 响应

#### 3.1.2 服务层

- **StockDataService**：提供股票历史数据的获取、存储和查询功能
- **DatabaseCache**：提供数据库缓存接口，使用主数据库作为持久化缓存

#### 3.1.3 数据访问层

- **AKShareAdapter**：封装 AKShare API 调用，提供错误处理和重试逻辑
- **数据库模型**：定义数据库表结构和关系

#### 3.1.4 数据库

- **SQLite/PostgreSQL**：存储股票数据和元数据
- **数据表**：Asset、DailyStockData 等

### 3.2 辅助组件

- **日志系统**：记录系统运行日志
- **配置管理**：管理系统配置
- **错误处理**：统一处理系统错误

## 4. 组件交互

### 4.1 数据获取流程

```
┌─────────┐     ┌───────────────┐     ┌──────────────┐     ┌──────────────┐
│  客户端  │────▶│    API 层     │────▶│  服务层      │────▶│ 数据库缓存   │
└─────────┘     └───────────────┘     └──────────────┘     └──────────────┘
                                            │                     │
                                            │                     │
                                            ▼                     ▼
                                      ┌──────────────┐     ┌──────────────┐
                                      │ AKShare 适配器│     │   数据库     │
                                      └──────────────┘     └──────────────┘
```

1. 客户端发送请求到 API 层
2. API 层验证请求并调用服务层
3. 服务层检查数据库缓存中是否有请求的数据
4. 如果数据存在，直接返回
5. 如果数据不存在或部分存在，服务层确定缺失的数据范围
6. 服务层调用 AKShare 适配器获取缺失的数据
7. 服务层将获取的数据保存到数据库缓存
8. 服务层返回完整的数据给 API 层
9. API 层格式化响应并返回给客户端

### 4.2 智能数据获取策略

```
┌─────────────────┐
│ 接收数据请求    │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 检查数据库缓存  │
└────────┬────────┘
         │
         ▼
┌─────────────────┐     ┌─────────────────┐
│ 确定缺失数据范围│────▶│ 分组连续日期    │
└────────┬────────┘     └────────┬────────┘
         │                       │
         │                       ▼
         │              ┌─────────────────┐
         │              │ 获取缺失数据    │
         │              └────────┬────────┘
         │                       │
         │                       ▼
         │              ┌─────────────────┐
         │              │ 保存到数据库    │
         │              └────────┬────────┘
         │                       │
         ▼                       ▼
┌─────────────────────────────────────────┐
│            合并数据并返回              │
└─────────────────────────────────────────┘
```

1. 接收数据请求，包含股票代码和日期范围
2. 检查数据库缓存，确定哪些日期的数据已存在
3. 确定缺失的数据范围
4. 将缺失的日期分组为连续的日期范围，减少 API 调用次数
5. 对每个日期范围，调用 AKShare 适配器获取数据
6. 将获取的数据保存到数据库
7. 合并缓存数据和新获取的数据，返回完整结果

## 5. 数据模型

### 5.1 数据库模型

#### Asset

| 字段 | 类型 | 描述 |
|------|------|------|
| asset_id | Integer | 主键 |
| symbol | String | 股票代码 |
| name | String | 股票名称 |
| isin | String | 国际证券识别码 |
| asset_type | String | 资产类型 |
| exchange | String | 交易所 |
| currency | String | 货币 |

#### DailyStockData

| 字段 | 类型 | 描述 |
|------|------|------|
| id | Integer | 主键 |
| asset_id | Integer | 外键，关联 Asset |
| trade_date | Date | 交易日期 |
| open | Float | 开盘价 |
| high | Float | 最高价 |
| low | Float | 最低价 |
| close | Float | 收盘价 |
| volume | Integer | 成交量 |
| turnover | Float | 成交额 |
| amplitude | Float | 振幅 |
| pct_change | Float | 涨跌幅 |
| change | Float | 涨跌额 |
| turnover_rate | Float | 换手率 |

## 6. 接口设计

### 6.1 服务接口

#### StockDataService

```python
class StockDataService:
    def get_stock_data(symbol, start_date, end_date, adjust=""):
        """获取股票历史数据"""
        pass
```

#### DatabaseCache

```python
class DatabaseCache:
    def get(symbol, dates):
        """从数据库获取数据"""
        pass

    def save(symbol, data):
        """保存数据到数据库"""
        pass

    def get_date_range_coverage(symbol, start_date, end_date):
        """获取日期范围的覆盖情况"""
        pass

    def get_stats():
        """获取缓存统计信息"""
        pass
```

#### AKShareAdapter

```python
class AKShareAdapter:
    def get_stock_data(symbol, start_date, end_date, adjust="", use_mock_data=False, period="daily"):
        """获取股票历史数据"""
        pass
```

### 6.2 API 接口

#### 获取股票历史数据

```
GET /api/v2/historical/stock/{symbol}
```

#### 获取数据库缓存状态

```
GET /api/v2/database/cache/status
```

## 7. 部署架构

```
┌─────────────────────────────────────────────────────────────┐
│                        应用服务器                           │
│                                                             │
│  ┌─────────────┐     ┌─────────────┐     ┌─────────────┐   │
│  │   FastAPI   │────▶│  服务层     │────▶│ 数据访问层  │   │
│  └─────────────┘     └─────────────┘     └─────────────┘   │
│                                                │            │
└────────────────────────────────────────────────┼────────────┘
                                                 │
                                                 ▼
                                          ┌─────────────┐
                                          │   数据库    │
                                          └─────────────┘
```

## 8. 安全考虑

- **API 认证**：使用 API Key 进行认证
- **数据验证**：验证输入数据，防止注入攻击
- **错误处理**：适当处理错误，不泄露敏感信息
- **日志记录**：记录关键操作，便于审计和问题排查

## 9. 性能考虑

- **数据库索引**：为常用查询字段创建索引
- **连接池**：使用数据库连接池，减少连接开销
- **缓存策略**：智能缓存策略，减少不必要的 API 调用
- **批量操作**：使用批量操作，减少数据库交互次数

## 10. 可扩展性考虑

- **模块化设计**：各组件职责明确，便于扩展
- **接口抽象**：使用抽象接口，便于替换实现
- **配置驱动**：使用配置驱动，便于调整系统行为
- **扩展点**：为未来支持更多数据类型和数据源预留扩展点

## 11. 版本历史

| 版本 | 日期 | 更新内容 |
|------|------|----------|
| 1.0.0 | 2025-06-07 | 初始版本 |

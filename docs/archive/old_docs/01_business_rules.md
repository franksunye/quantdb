# 业务规则参考

## 1. 交易信号处理规则

### 1.1 信号生成
- 交易信号由策略生成，存储在 `trade_signals` 表中
- 信号类型包括 `BUY` 和 `SELL`
- 信号包含以下关键信息：
  - 策略ID (`strategy_id`)
  - 资产ID (`asset_id`)
  - 信号日期 (`signal_date`)
  - 信号类型 (`signal_type`)
  - 信号强度 (`signal_strength`)
  - 信号价格 (`price_at_signal`)
  - 建议交易数量 (`suggested_quantity`)
  - 最优结果 (`optimal_result`)

### 1.2 信号发送
- 未发送的信号标记为 `signal_sent = 0`
- 信号发送后更新为 `signal_sent = 1`
- 信号通过企业微信Webhook发送

### 1.3 交易计划生成
- 未生成计划的信号标记为 `plan_generated = 0`
- 计划生成后更新为 `plan_generated = 1`
- BUY信号生成新的交易计划
- SELL信号匹配现有的未完成交易计划并更新

## 2. 交易计划规则

### 2.1 计划状态
- `PENDING`: 初始状态，计划已创建但未执行
- `ACTIVE`: 计划已激活或执行，处于进行中状态
- `COMPLETED`: 计划已成功完成，所有预定操作已执行
- `CANCELLED`: 计划被取消，可能由于市场条件变化或其他原因
- `FAILED`: 计划执行失败，可能由于技术问题、市场波动等

### 2.2 计划执行
- 入场价格 (`entry_price`) 和出场价格 (`exit_price`) 记录实际交易价格
- 入场日期 (`entry_date`) 和出场日期 (`exit_date`) 记录实际交易日期
- 入场订单量 (`order_entry`) 和出场订单量 (`order_exit`) 记录交易数量
- 入场滑点 (`slip_entry`) 和出场滑点 (`slip_exit`) 记录价格滑点
- 入场佣金 (`comm_entry`) 和出场佣金 (`comm_exit`) 记录交易佣金

## 3. 绩效计算规则

### 3.1 盈亏计算
- 盈亏 (`pnl`) = 出场价格 × 出场订单量 - 入场价格 × 入场订单量
- 净收益 (`net`) = 盈亏 - 入场佣金 - 出场佣金 - 费用

### 3.2 绩效指标
- 胜率 = 盈利交易数 / 总交易数
- 盈亏比 = 总盈利金额 / 总亏损金额
- 入场涨跌幅 (`entry_pct_change`) 记录入场时的价格变动百分比
- 出场涨跌幅 (`exit_pct_change`) 记录出场时的价格变动百分比
- 交易表现 (`trade_p`) 综合评估交易的整体表现

## 4. 数据更新规则

### 4.1 股票数据更新
- 日线数据每日收盘后更新
- 实时数据在交易时段内定时更新
- 避免重复插入相同日期的数据

### 4.2 指数成分股更新
- 定期更新指数成分股列表
- 记录股票纳入指数的日期 (`inclusion_date`)
- 记录股票移出指数的日期 (`exclusion_date`)

## 5. 回测与优化规则

### 5.1 回测参数
- 回测记录策略ID、资产ID、开始日期、结束日期和参数
- 回测结果记录性能指标

### 5.2 优化结果
- 优化结果记录最优参数值和对应的性能指标
- 优化结果可用于生成交易信号

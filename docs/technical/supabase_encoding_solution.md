# Supabaseç¼–ç é—®é¢˜è§£å†³æ–¹æ¡ˆ

## æ–‡æ¡£ä¿¡æ¯
**æ–‡æ¡£ç±»å‹**: æŠ€æœ¯è§£å†³æ–¹æ¡ˆ
**æ–‡æ¡£ç¼–å·**: quantdb-TECH-SOLUTION-001
**ç‰ˆæœ¬**: 1.1.0
**åˆ›å»ºæ—¥æœŸ**: 2025-05-17
**æœ€åæ›´æ–°**: 2025-05-18
**çŠ¶æ€**: å·²å®Œæˆ
**è´Ÿè´£äºº**: frank

## é—®é¢˜æ¦‚è¿°

åœ¨QuantDBé¡¹ç›®ä¸­é›†æˆSupabaseä½œä¸ºäº‘æ•°æ®åº“è§£å†³æ–¹æ¡ˆæ—¶ï¼Œæˆ‘ä»¬é‡åˆ°äº†ä¸€ç³»åˆ—ä¸ç¼–ç ç›¸å…³çš„æŠ€æœ¯æŒ‘æˆ˜ï¼Œç‰¹åˆ«æ˜¯åœ¨ä¸­æ–‡Windowsç¯å¢ƒä¸‹ã€‚è¿™äº›é—®é¢˜ä¸»è¦è¡¨ç°ä¸ºï¼š

1. ä½¿ç”¨psycopg2è¿æ¥Supabase PostgreSQLæ•°æ®åº“æ—¶å‡ºç°ç¼–ç é”™è¯¯
2. æ— æ³•é€šè¿‡è„šæœ¬è‡ªåŠ¨åˆ›å»ºæ•°æ®åº“è¡¨å’Œç»“æ„
3. ç¯å¢ƒå˜é‡è§£æé—®é¢˜

## é—®é¢˜åˆ†æ

### 1. psycopg2ç¼–ç é”™è¯¯

#### é”™è¯¯ä¿¡æ¯
```
'utf-8' codec can't decode byte 0xb2 in position 80: invalid start byte
```

#### æ ¹æœ¬åŸå› 
- ä¸­æ–‡Windowsç¯å¢ƒé»˜è®¤ä½¿ç”¨GBKæˆ–CP936ç¼–ç ï¼Œè€Œä¸æ˜¯UTF-8
- Pythoné»˜è®¤ä½¿ç”¨UTF-8ç¼–ç 
- psycopg2åœ¨å¤„ç†è¿æ¥å­—ç¬¦ä¸²æ—¶ï¼Œå¯èƒ½ä¼šå°è¯•å°†GBKç¼–ç çš„å­—ç¬¦ä¸²ä»¥UTF-8è§£ç ï¼Œå¯¼è‡´ç¼–ç é”™è¯¯
- ç‰¹åˆ«æ˜¯å½“å¯†ç ä¸­åŒ…å«ç‰¹æ®Šå­—ç¬¦æ—¶ï¼Œè¿™ä¸ªé—®é¢˜æ›´åŠ æ˜æ˜¾

#### æµ‹è¯•ç»“æœ
æˆ‘ä»¬æµ‹è¯•äº†å¤šç§è§£å†³æ–¹æ¡ˆï¼š

1. **ç¼–ç è½¬æ¢ä¸­é—´å±‚**ï¼šå°è¯•åœ¨è¿æ¥å‰å¯¹å­—ç¬¦ä¸²è¿›è¡Œç¼–ç è½¬æ¢
   - ç»“æœï¼šå¤±è´¥
   - åŸå› ï¼šç¼–ç é—®é¢˜å‘ç”Ÿåœ¨psycopg2å†…éƒ¨ï¼Œæ— æ³•é€šè¿‡å¤–éƒ¨è½¬æ¢è§£å†³

2. **ç›´æ¥ä½¿ç”¨è¿æ¥å‚æ•°**ï¼šé¿å…è§£æURLï¼Œç›´æ¥ä½¿ç”¨è¿æ¥å‚æ•°
   - ç»“æœï¼šå¤±è´¥
   - åŸå› ï¼šåŒæ ·é‡åˆ°ç¼–ç é—®é¢˜

3. **ä½¿ç”¨REST API**ï¼šä½¿ç”¨Supabaseçš„REST APIè€Œä¸æ˜¯ç›´æ¥è¿æ¥æ•°æ®åº“
   - ç»“æœï¼šæˆåŠŸ
   - åŸå› ï¼šREST APIä½¿ç”¨HTTPåè®®ï¼Œä¸å—æœ¬åœ°ç¼–ç å½±å“

4. **ä½¿ç”¨æ›¿ä»£PostgreSQLå®¢æˆ·ç«¯**ï¼šå°è¯•ä½¿ç”¨å…¶ä»–å®¢æˆ·ç«¯åº“å¦‚pg8000
   - ç»“æœï¼šæœªæµ‹è¯•å®Œæˆ
   - åŸå› ï¼šéœ€è¦å®‰è£…é¢å¤–ä¾èµ–

### 2. ç¯å¢ƒå˜é‡é—®é¢˜

#### é—®é¢˜æè¿°
- .envæ–‡ä»¶ä¸­æœ‰é‡å¤çš„DATABASE_URLå®šä¹‰
- ç¯å¢ƒå˜é‡ç®¡ç†ä¸è§„èŒƒ
- å¯†ç ä¸­çš„ç‰¹æ®Šå­—ç¬¦å¯èƒ½å¯¼è‡´è§£æé—®é¢˜

#### è§£å†³æ–¹æ¡ˆ
- åˆ›å»ºäº†ç¯å¢ƒå˜é‡ç®¡ç†å·¥å…·
- å®ç°äº†ç¯å¢ƒå˜é‡éªŒè¯åŠŸèƒ½
- æ·»åŠ äº†ç¯å¢ƒå˜é‡æ¨¡æ¿ç”ŸæˆåŠŸèƒ½
- è§„èŒƒäº†ç¯å¢ƒå˜é‡å®šä¹‰æ ¼å¼

## æ¨èè§£å†³æ–¹æ¡ˆ

ç»è¿‡å…¨é¢æµ‹è¯•å’Œåˆ†æï¼Œæˆ‘ä»¬æ¨èé‡‡ç”¨ä»¥ä¸‹è§£å†³æ–¹æ¡ˆï¼š

### 1. ä½¿ç”¨REST APIæ›¿ä»£ç›´æ¥æ•°æ®åº“è¿æ¥

#### æ–¹æ¡ˆæè¿°
å®Œå…¨ä½¿ç”¨Supabaseçš„REST APIè¿›è¡Œæ•°æ®æ“ä½œï¼Œé¿å…ç›´æ¥è¿æ¥æ•°æ®åº“ã€‚

#### å®ç°æ–¹å¼
```python
class SupabaseRestClient:
    """Supabase REST APIå®¢æˆ·ç«¯"""

    def __init__(self, url, key):
        """åˆå§‹åŒ–å®¢æˆ·ç«¯"""
        self.url = url
        self.key = key
        self.headers = {
            "apikey": key,
            "Content-Type": "application/json"
        }

    def select(self, table, columns="*", filters=None, limit=None):
        """æŸ¥è¯¢æ•°æ®"""
        query_url = f"{self.url}/rest/v1/{table}?select={columns}"

        if filters:
            for key, value in filters.items():
                query_url += f"&{key}=eq.{value}"

        if limit:
            query_url += f"&limit={limit}"

        response = requests.get(query_url, headers=self.headers)

        if response.status_code == 200:
            return response.json()
        else:
            raise Exception(f"æŸ¥è¯¢å¤±è´¥: {response.status_code} - {response.text}")

    def insert(self, table, data):
        """æ’å…¥æ•°æ®"""
        response = requests.post(
            f"{self.url}/rest/v1/{table}",
            headers=self.headers,
            json=data
        )

        if response.status_code == 201:
            return response.json()
        else:
            raise Exception(f"æ’å…¥å¤±è´¥: {response.status_code} - {response.text}")

    def update(self, table, data, filters):
        """æ›´æ–°æ•°æ®"""
        query_url = f"{self.url}/rest/v1/{table}"

        for key, value in filters.items():
            query_url += f"?{key}=eq.{value}"

        response = requests.patch(
            query_url,
            headers=self.headers,
            json=data
        )

        if response.status_code == 200:
            return response.json()
        else:
            raise Exception(f"æ›´æ–°å¤±è´¥: {response.status_code} - {response.text}")

    def delete(self, table, filters):
        """åˆ é™¤æ•°æ®"""
        query_url = f"{self.url}/rest/v1/{table}"

        for key, value in filters.items():
            query_url += f"?{key}=eq.{value}"

        response = requests.delete(
            query_url,
            headers=self.headers
        )

        if response.status_code == 200:
            return True
        else:
            raise Exception(f"åˆ é™¤å¤±è´¥: {response.status_code} - {response.text}")
```

#### ä¼˜ç‚¹
- é¿å…äº†ç¼–ç é—®é¢˜
- ç®€åŒ–äº†æ•°æ®è®¿é—®é€»è¾‘
- æä¾›äº†ç»Ÿä¸€çš„APIæ¥å£
- ä¸éœ€è¦å¤„ç†æ•°æ®åº“è¿æ¥ç»†èŠ‚

#### ç¼ºç‚¹
- åŠŸèƒ½å¯èƒ½å—é™
- æ— æ³•æ‰§è¡Œå¤æ‚çš„SQLæŸ¥è¯¢
- æ€§èƒ½å¯èƒ½ç•¥ä½äºç›´æ¥æ•°æ®åº“è¿æ¥

### 2. æ ‡å‡†åŒ–ç¯å¢ƒå˜é‡ç®¡ç†

#### æ–¹æ¡ˆæè¿°
ä½¿ç”¨ç¯å¢ƒå˜é‡ç®¡ç†å·¥å…·ï¼Œè§„èŒƒç¯å¢ƒå˜é‡å®šä¹‰å’Œä½¿ç”¨ã€‚

#### å®ç°æ–¹å¼
```python
# ä½¿ç”¨ç¯å¢ƒå˜é‡ç®¡ç†å·¥å…·
from scripts.env_manager import EnvManager

# åˆ›å»ºç¯å¢ƒå˜é‡ç®¡ç†å™¨
env_manager = EnvManager('.env')

# éªŒè¯ç¯å¢ƒå˜é‡
env_manager.validate_env_vars()
env_manager.validate_database_url()
env_manager.validate_supabase_config()

# è·å–ç¯å¢ƒå˜é‡
supabase_url = os.getenv('SUPABASE_URL')
supabase_key = os.getenv('SUPABASE_KEY')

# åˆ›å»ºSupabaseå®¢æˆ·ç«¯
supabase_client = SupabaseRestClient(supabase_url, supabase_key)
```

#### ä¼˜ç‚¹
- è§„èŒƒäº†ç¯å¢ƒå˜é‡ç®¡ç†
- æä¾›äº†éªŒè¯åŠŸèƒ½
- é¿å…äº†é‡å¤å®šä¹‰å’Œè§£æé”™è¯¯
- æé«˜äº†ä»£ç å¯ç»´æŠ¤æ€§

## å®æ–½è¿›å±•

### 1. åˆ›å»ºSupabase REST APIå®¢æˆ·ç«¯ âœ…

æˆ‘ä»¬å·²ç»å®ç°äº†å®Œæ•´çš„Supabase REST APIå®¢æˆ·ç«¯ï¼ˆ`src/db/supabase_rest_client.py`ï¼‰ï¼ŒåŒ…æ‹¬ï¼š

- å®ç°äº†åŸºæœ¬çš„CRUDæ“ä½œï¼ˆselect, insert, update, deleteï¼‰
- æ·»åŠ äº†é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•
- æ”¯æŒå¤æ‚æŸ¥è¯¢å’Œè¿‡æ»¤
- æ”¯æŒSQLæ‰§è¡Œå’Œå­˜å‚¨è¿‡ç¨‹è°ƒç”¨
- æä¾›äº†æœåŠ¡è§’è‰²å’ŒåŒ¿åè§’è‰²çš„æ”¯æŒ

### 2. æ›´æ–°æ•°æ®è®¿é—®å±‚ ğŸ”„

- åˆ›å»ºäº†åŸºäºREST APIçš„æ•°æ®è®¿é—®å±‚
- ç¡®ä¿APIå…¼å®¹æ€§ï¼Œæœ€å°åŒ–ä»£ç ä¿®æ”¹
- æ·»åŠ äº†é€‚å½“çš„æ—¥å¿—è®°å½•
- å®ç°äº†åŸºæœ¬çš„æ€§èƒ½ä¼˜åŒ–

### 3. å®Œå–„ç¯å¢ƒå˜é‡ç®¡ç† âœ…

- åˆ›å»ºäº†ç¯å¢ƒå˜é‡ç®¡ç†å·¥å…·ï¼ˆ`scripts/env_manager.py`ï¼‰
- å®ç°äº†ç¯å¢ƒå˜é‡éªŒè¯åŠŸèƒ½
- æ·»åŠ äº†ç¯å¢ƒå˜é‡æ¨¡æ¿ç”ŸæˆåŠŸèƒ½
- æ”¯æŒç¯å¢ƒå˜é‡å¯¼å‡ºå’Œå¯¼å…¥
- è§„èŒƒäº†ç¯å¢ƒå˜é‡å®šä¹‰æ ¼å¼

## æµ‹è¯•ç»“æœ

### 1. å•å…ƒæµ‹è¯• âœ…

- æµ‹è¯•äº†REST APIå®¢æˆ·ç«¯çš„å„ä¸ªæ–¹æ³•ï¼Œç¡®è®¤åŠŸèƒ½æ­£å¸¸
- æµ‹è¯•äº†ç¯å¢ƒå˜é‡ç®¡ç†å·¥å…·çš„åŠŸèƒ½ï¼ŒéªŒè¯äº†éªŒè¯å’Œæ¨¡æ¿ç”ŸæˆåŠŸèƒ½
- æµ‹è¯•äº†é”™è¯¯å¤„ç†å’Œè¾¹ç•Œæƒ…å†µï¼Œç¡®ä¿ç³»ç»Ÿç¨³å®šæ€§

### 2. é›†æˆæµ‹è¯• âœ…

- æµ‹è¯•äº†ä¸Supabaseçš„é›†æˆï¼Œç¡®è®¤è¿æ¥æ­£å¸¸
- æµ‹è¯•äº†æ•°æ®è®¿é—®å±‚çš„åŠŸèƒ½ï¼ŒéªŒè¯äº†CRUDæ“ä½œ
- æµ‹è¯•äº†ä¸åŒç¯å¢ƒä¸‹çš„é…ç½®åŠ è½½ï¼Œç¡®ä¿ç¯å¢ƒå˜é‡æ­£ç¡®å¤„ç†

### 3. æ€§èƒ½æµ‹è¯• âœ…

- æµ‹è¯•äº†REST APIçš„å“åº”æ—¶é—´ï¼Œæ€§èƒ½æ»¡è¶³éœ€æ±‚
- æµ‹è¯•äº†æ‰¹é‡æ“ä½œçš„æ€§èƒ½ï¼Œç¡®è®¤å¯ä»¥å¤„ç†å¤§é‡æ•°æ®
- æµ‹è¯•äº†ç¼“å­˜æœºåˆ¶çš„æ•ˆæœï¼ŒéªŒè¯äº†æ€§èƒ½ä¼˜åŒ–æ•ˆæœ

### 4. è‡ªåŠ¨åŒ–æµ‹è¯• âœ…

- åˆ›å»ºäº†Supabaseç®¡ç†å·¥å…·æµ‹è¯•è„šæœ¬ï¼ˆ`scripts/test_supabase_management_api.py`ï¼‰
- æµ‹è¯•äº†Supabase Management APIçš„è¿æ¥å’ŒåŠŸèƒ½
- æµ‹è¯•äº†é¡¹ç›®ç®¡ç†ã€æ•°æ®åº“æ“ä½œå’ŒAPIå¯†é’¥ç®¡ç†åŠŸèƒ½

## ç»“è®º

é€šè¿‡ä½¿ç”¨REST APIæ›¿ä»£ç›´æ¥æ•°æ®åº“è¿æ¥ï¼Œæˆ‘ä»¬æˆåŠŸè§£å†³äº†ä¸­æ–‡Windowsç¯å¢ƒä¸‹çš„ç¼–ç é—®é¢˜ã€‚è¿™ç§æ–¹æ³•ä¸ä»…é¿å…äº†ç¼–ç é—®é¢˜ï¼Œè¿˜æä¾›äº†æ›´ç®€å•ã€æ›´ç»Ÿä¸€çš„æ•°æ®è®¿é—®æ¥å£ã€‚

åŒæ—¶ï¼Œé€šè¿‡æ ‡å‡†åŒ–ç¯å¢ƒå˜é‡ç®¡ç†ï¼Œæˆ‘ä»¬æé«˜äº†ä»£ç çš„å¯ç»´æŠ¤æ€§å’Œå¯é æ€§ï¼Œé¿å…äº†ç¯å¢ƒå˜é‡ç›¸å…³çš„é—®é¢˜ã€‚

æ­¤å¤–ï¼Œæˆ‘ä»¬å¼€å‘äº†ä¸€å¥—å®Œæ•´çš„Supabaseç®¡ç†å·¥å…·ï¼ŒåŒ…æ‹¬é¡¹ç›®ç®¡ç†ã€æ•°æ®åº“æ“ä½œã€APIå¯†é’¥ç®¡ç†ç­‰åŠŸèƒ½ï¼Œä½¿æˆ‘ä»¬èƒ½å¤Ÿä»¥ç¼–ç¨‹æ–¹å¼ç®¡ç†SupabaseæœåŠ¡ï¼Œè€Œä¸æ˜¯ä¾èµ–æ‰‹åŠ¨ä»ªè¡¨æ¿æ“ä½œã€‚

è¿™äº›è§£å†³æ–¹æ¡ˆå°†ä¸ºQuantDBé¡¹ç›®çš„Supabaseé›†æˆå¥ å®šåšå®çš„åŸºç¡€ï¼Œä½¿æˆ‘ä»¬èƒ½å¤Ÿå……åˆ†åˆ©ç”¨Supabaseçš„åŠŸèƒ½ï¼ŒåŒæ—¶é¿å…ç¼–ç ç›¸å…³çš„æŠ€æœ¯æŒ‘æˆ˜ã€‚

## åç»­å·¥ä½œ

1. **å®Œæˆæ•°æ®åº“æ¶æ„è®¾è®¡**ï¼šç»§ç»­å®ŒæˆSupabaseè¡¨ç»“æ„è®¾è®¡å’Œæ•°æ®ç±»å‹æ˜ å°„
2. **å¼€å‘è‡ªåŠ¨åŒ–è¿ç§»å·¥å…·**ï¼šå¼€å‘SQLiteåˆ°Supabaseçš„æ•°æ®è¿ç§»å·¥å…·
3. **å®ç°è¡Œçº§å®‰å…¨ç­–ç•¥**ï¼šè®¾è®¡å’Œå®ç°å®Œæ•´çš„è¡Œçº§å®‰å…¨ç­–ç•¥
4. **é›†æˆåˆ°ä¸»é¡¹ç›®**ï¼šå°†Supabase RESTå®¢æˆ·ç«¯å’Œç®¡ç†å·¥å…·é›†æˆåˆ°ä¸»é¡¹ç›®ä¸­
5. **å®Œå–„æ–‡æ¡£**ï¼šæ›´æ–°æŠ€æœ¯æ–‡æ¡£ï¼Œæ·»åŠ ä½¿ç”¨ç¤ºä¾‹å’Œæœ€ä½³å®è·µ

## å‚è€ƒèµ„æ–™

1. [Supabase REST APIæ–‡æ¡£](https://supabase.io/docs/reference/javascript/supabase-client)
2. [Pythonç¼–ç å¤„ç†æœ€ä½³å®è·µ](https://docs.python.org/3/howto/unicode.html)
3. [psycopg2æ–‡æ¡£ - ç¼–ç é—®é¢˜](https://www.psycopg.org/docs/usage.html#unicode-handling)
4. [ç¯å¢ƒå˜é‡æœ€ä½³å®è·µ](https://12factor.net/config)
